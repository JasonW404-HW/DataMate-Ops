# 病理系统数据预处理算子 — 用户指南

## 快速开始 (How to Use)

1. **环境准备**：请注意，本算子涉及到 DataMate 平台数据集文件添加的操作，因此请确保在宿主机环境和 **DataMate Backend** 容器环境中均可访问医院图像存储路径。**请记录医院图像存储在容器中的路径。**
2. **准备 CSV 文件**：将 诊断 CSV (Diagnosis CSV) 和 切片 CSV (Slide CSV) 存放在同一数据集中。如果是通过 DataMate 的数据归集功能获得的文件，则请务必将归集目标数据集设置为同一个。
3. **在 DataMate 页面上创建任务**：
    - **添加算子**: 在 DataMate 的“算子市场”中上传本算子并发布。
    - **清洗任务**：使用步骤 *2* 中的数据集作为源数据集。在 DataMate 的“数据清洗”-“创建清洗任务”-“配置清洗流程”区域，选择本算子。设置 `pathTransformer` 和 `ignoreSdpc`。创建清洗任务。
      - `pathTranformer`：具体配置方法请参考下文。**注意**：请务必再三检查医院图像存储路径是否填写正确。
        - **是容器中的路径，不是宿主机上的路径！**
        - **是容器中的路径，不是宿主机上的路径！**
        - **是容器中的路径，不是宿主机上的路径！**
4. **检查结果**：在目标数据集中，检查是否有一个包含了所有图片路径和信息的TXT文件（实质内容为CSV数据），以及若干WSI图片及其缩略图。

---

## 本地开发与调试 (Developers Only)

开发者可以 clone 本项目到本地，通过运行项目根目录下的 `main.py` 来模拟平台环境并调试算子逻辑。

### 1. 环境准备

1. **Clone 项目**：
   ```bash
   git clone <repository_url>
   cd DataMate-Ops
   ```
2. **安装 uv** (如果尚未安装)：
   请参考 [uv 官方文档](https://github.com/astral-sh/uv) 进行安装。
3. **初始化环境与依赖**：
   在项目根目录下执行，uv 会自动创建虚拟环境并同步所有依赖：
   ```bash
   uv sync
   ```

### 2. 使用 main.py 进行调试

项目根目录的 `main.py` 是一个专为开发者准备的测试桩（Test Stub）。它会自动读取 `./patho_sys_preprocess/dataset/source/` 下的 CSV 文件并调用算子执行。

#### 如何配置 main.py：

1. **修改参数**：打开 `main.py`，在 `test_operator()` 函数中修改 `params` 字典，以匹配你想要测试的 UI 配置：
   ```python
   def test_operator():
       params = {
           'pathTransformer': '/storage:/mnt/ruipath/hospital_data/', # 对应 UI 的路径转换规则
           'ignoreSdpc': False                                       # 对应 UI 的忽略开关
       }
       # ...
   ```
2. **准备测试数据**：确保 `./patho_sys_preprocess/dataset/source/` 目录下存放了用于测试的诊断 CSV 和切片 CSV。
3. **运行调试**：
   ```bash
   uv run main.py
   ```

通过查看控制台输出的 `OpsLogger` 日志，你可以观察数据的合并、路径转换以及 API 上传模拟过程。

---

## 算子简介

本算子专门用于预处理从病理信息系统 (PIS) 或检验管理系统 (MIS) 导出的结构化表格数据。通过清理路径、过滤无效切片并关联诊断信息，生成可供标注任务或模型训练使用的数据集记录。

- **脚本路径**: [patho_sys_preprocess/process.py](patho_sys_preprocess/process.py)
- **元数据配置**: [patho_sys_preprocess/metadata.yml](patho_sys_preprocess/metadata.yml)

## 主要功能

*   **多表关联**: 自动查找并合并诊断信息与切片路径。
*   **路径转换**: 支持绝对路径替换、挂载点补全及路径原样保留。
*   **WSI 特殊处理**: 针对 `.sdpc` 格式提供自动过滤规则（如缺失缩略图则剔除）。
*   **自动上传**: 自动将处理后的元数据分批同步至 DataMate 后端 API。

---

## 详细参考

### 1. 输入文件规范

*   **诊断 CSV**: 必须包含字段 `case_no`, `diagnosis`。
*   **切片 CSV**: 必须包含字段 `case_no`, `slide_path`；若包含 `thumbnail_path` 会被同步转换并上传。
*   **输入 Sample**: 
    *   `filePath` (str): 诊断表路径。
    *   `export_path` (Path): 导出目标路径，其 `.name` 属性作为 API 端点的数据集 ID。

### 2. UI 参数配置 (Operator Settings)

在平台 UI 的算子设置区域，你可以看到以下可配置项：

| UI 名称                  | 参数 Key          | 类型           | 默认值                                | 如何配置                                                                  |
| :----------------------- | :---------------- | :------------- | :------------------------------------ | :------------------------------------------------------------------------ |
| **路径转换规则**         | `pathTransformer` | 输入框 (Input) | `/storage:/mnt/ruipath/hospital_data` | 设置源文件路径如何映射到当前挂载环境（见下文）。                          |
| **忽略 SDPC 格式的切片** | `ignoreSdpc`      | 开关 (Switch)  | `false (保留)`                        | **忽略**：剔除所有 .sdpc 文件；**保留**：尝试转换并保留有缩略图的 .sdpc。 |

#### “路径转换规则”填法详解

根据你的原始数据路径情况，在输入框中按以下格式填写：

*   **模式 A：保持路径不变**
    - **填法**：输入 `<>`。
    - **场景**：原始 CSV 中的路径已是当前平台环境下的正确绝对路径。

*   **模式 B：相对路径补全**
    - **填法**：直接输入挂载点的 **绝对路径**。
    - **场景**：原始 CSV 中是相对路径（如 `slides/1.svs`），你需要将其补全为（如 `/mnt/data/slides/1.svs`）。
    - **示例**：在 UI 中填写 `/mnt/data/`。

*   **模式 C：前缀替换 (最常用)**
    - **填法**：`旧前缀:新前缀`。
    - **场景**：数据搬迁或挂载点变更。
    - **示例**：如果旧路径是 `/storage/data/1.svs`，平台新挂载点是 `/mnt/hospital/`，则在 UI 中填写 `/storage/:/mnt/hospital/`。

#### “忽略 SDPC”填法详解

*   **开启 (忽略)**：开启后，所有以 `.sdpc` 结尾的切片记录都将被过滤掉，不导入数据集。
*   **关闭 (保留)**：算子会检查 `.sdpc` 文件是否有对应的 `thumbnail_path`。若没有缩略图，该 `.sdpc` 仍会被自动剔除（WSI 必须有缩略图才能在标注端显示）。

### 3. 处理逻辑与过滤规则

1.  **查找切片表**: 算子会自动查找与诊断表同目录下的“非诊断表” CSV 文件。
2.  **空值清理**: 剔除所有 `slide_path` 为空的行。
3.  **SDPC 兼容性**: 
    - 若 `ignoreSdpc` 为关闭状态，算子会检查 `.sdpc` 文件是否具有对应的 `thumbnail_path`。
    - **无缩略图的 SDPC 切片会被自动剔除**，以保证标注端的正常显示。
4.  **数据流向**:
    - **分批上传**: 每 1000 条记录发起一次后端 API 请求。
    - **Sample 更新**: `sample["text"]` 将存储最终关联成功的 JSON 字符串。

### 4. 日志说明

系统通过 `OpsLogger` 输出带有视觉标识的日志，便于在大量流水线日志中快速定位：
- 🟢 信息: `🟧🟧🟧 [消息内容] 🟦🟦🟦`
- 🔴 错误: `🟧🟧🟧 [错误详情] 🟦🟦🟦`

---

## 常见问题 (FAQ)

- **Q: 为什么没找到切片文件？**  
  A: 请确保医院图像存储已经成功挂载，并在容器中可访问。请检查文件权限是否可读。请检查是否存在多个图像存储来源，如果是，则都需要挂载。请检查 CSV 文件中的路径是否正确。
  
- **Q: 路径转换后的结果不对？**  
  A: 请检查 `pathTransformer` 是否包含不必要的尾部斜杠，或确认源路径是否确实以配置的前缀开头。

- **Q: 上传 API 报错 404/500？**  
  A: 检查 `export_path` 指定的文件夹名在 DataMate 后端是否已预先创建为数据集。